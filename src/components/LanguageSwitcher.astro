---
import { getLangFromUrl, languages, getLocalizedPath } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;

// Remove language prefix from path to get the base path
const basePath = currentPath.replace(/^\/(zh|en)/, '') || '/';

const otherLang = lang === 'zh' ? 'en' : 'zh';
const otherLangPath = getLocalizedPath(basePath, otherLang);
---

<div class="relative" x-data="{ open: false }">
  <button
    @click="open = !open"
    @click.outside="open = false"
    type="button"
    class="flex items-center gap-x-1.5 px-3 py-2 text-sm font-medium text-neutral-700 transition hover:text-neutral-600 rounded-lg hover:bg-neutral-50"
    aria-label="Switch language"
  >
    <svg
      class="h-4 w-4"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill="currentColor"
      aria-hidden="true"
    >
      <path
        fill-rule="evenodd"
        d="M9 2.25a.75.75 0 0 1 .75.75v1.506a49.384 49.384 0 0 1 5.343.371.75.75 0 1 1-.186 1.489c-.66-.083-1.323-.151-1.99-.206a18.67 18.67 0 0 1-2.97 6.323c.318.384.65.753 1 1.107a.75.75 0 0 1-1.07 1.052A18.902 18.902 0 0 1 9 13.687a18.823 18.823 0 0 1-5.656 4.482.75.75 0 0 1-.688-1.333 17.323 17.323 0 0 0 5.396-4.353A18.72 18.72 0 0 1 5.89 8.598a.75.75 0 0 1 1.388-.568A17.21 17.21 0 0 0 9 11.224a17.168 17.168 0 0 0 2.391-5.165 48.04 48.04 0 0 0-8.298.307.75.75 0 0 1-.186-1.489 49.159 49.159 0 0 1 5.343-.371V3A.75.75 0 0 1 9 2.25ZM15.75 9a.75.75 0 0 1 .68.433l5.25 11.25a.75.75 0 1 1-1.36.634l-1.198-2.567h-6.744l-1.198 2.567a.75.75 0 0 1-1.36-.634l5.25-11.25A.75.75 0 0 1 15.75 9Zm-2.672 8.25h5.344l-2.672-5.726-2.672 5.726Z"
        clip-rule="evenodd"
      />
    </svg>
    <span class="uppercase">{lang}</span>
    <svg
      class="h-4 w-4 transition-transform"
      :class="open ? 'rotate-180' : ''"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill="currentColor"
      aria-hidden="true"
    >
      <path
        fill-rule="evenodd"
        d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z"
        clip-rule="evenodd"
      />
    </svg>
  </button>

  <div
    x-show="open"
    x-transition:enter="transition ease-out duration-100"
    x-transition:enter-start="opacity-0 scale-95"
    x-transition:enter-end="opacity-100 scale-100"
    x-transition:leave="transition ease-in duration-75"
    x-transition:leave-start="opacity-100 scale-100"
    x-transition:leave-end="opacity-0 scale-95"
    class="absolute right-0 mt-2 w-36 origin-top-right"
    style="display: none;"
  >
    <div class="backdrop-blur-md bg-white/95 border border-white/30 rounded-xl shadow-[0_2px_10px_0px_rgba(0,0,0,0.15)] py-1">
      <a
        href={basePath}
        class="flex items-center gap-x-2 px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors lang-switch-link"
        class:list={{ 'bg-neutral-50 font-medium': lang === 'en' }}
        data-lang="en"
      >
        <span>English</span>
      </a>
      <a
        href={`/zh${basePath}`}
        class="flex items-center gap-x-2 px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50 transition-colors lang-switch-link"
        class:list={{ 'bg-neutral-50 font-medium': lang === 'zh' }}
        data-lang="zh"
      >
        <span>中文</span>
      </a>
    </div>
  </div>
</div>

<script>
  // Save user's manual language choice to prevent auto-redirect
  document.querySelectorAll('.lang-switch-link').forEach(link => {
    link.addEventListener('click', () => {
      localStorage.setItem('yt-lang-choice', link.getAttribute('data-lang') || '');
    });
  });
</script>

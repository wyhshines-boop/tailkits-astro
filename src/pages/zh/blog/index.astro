---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getLangFromUrl, useTranslations } from '../../../i18n/utils';

// Get current language
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get all blog posts filtered by language and sort by date
const allPosts = await getCollection('blog', ({ data }) => {
  return data.lang === lang;
});
const sortedPosts = allPosts.sort((a, b) =>
  b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Get all unique tags
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags))];
---

<BaseLayout
  title={t('blog.title')}
  description={t('blog.description')}
>
  <section class="pt-12 lg:pt-16 pb-12 lg:pb-16">
    <div class="max-w-7xl mx-auto px-4 xl:px-0 flex flex-col">
      <div class="flex flex-col items-center">
        <div
          class="items-center justify-center rounded-full text-sm font-medium whitespace-nowrap shadow-[0_2px_10px_0px_rgba(0,0,0,0.15)] inline-flex bg-white text-neutral-700 px-2.5 py-1"
        >
          {lang === 'zh' ? '介绍 TailKits 博客' : 'Introducing TailKits Blog'}
        </div>
        <div
          class="mt-6 bg-gradient-to-b from-slate-800 to-slate-600 bg-clip-text text-center text-3xl font-semibold text-transparent sm:mx-auto sm:w-2/3 md:w-1/2 lg:mt-9 lg:text-4xl lg:leading-tight xl:w-2/3"
        >
          {lang === 'zh'
            ? '探索趋势、创新和故事，在 SaaS 的动态世界中'
            : 'Exploring Trends, Innovations, Stories in the Dynamic World of SaaS'}
        </div>
        <p
          class="text-sm font-medium text-slate-600 leading-normal lg:leading-normal lg:text-base mt-4 text-center sm:mx-auto sm:w-2/3 md:w-1/2 xl:w-2/5"
        >
          {lang === 'zh'
            ? '发现最新的创新、前沿技术和塑造 SaaS 格局的前瞻性理念'
            : 'Discover the latest innovations, cutting-edge technologies, and forward-thinking ideas shaping the SaaS landscape'}
        </p>
        <div class="mt-6 flex flex-wrap items-center justify-center gap-3">
          <button
            type="button"
            aria-label={lang === 'zh' ? '显示所有文章' : 'Show all posts'}
            class="py-1 px-2.5 text-sm flex items-center justify-center font-medium shadow-[0_2px_10px_0px_rgba(0,0,0,0.15)] rounded-full whitespace-nowrap text-white bg-slate-900"
          >
            {lang === 'zh' ? '显示全部' : 'Show all'}
          </button>
          {allTags.slice(0, 4).map(tag => (
            <button
              type="button"
              aria-label={`${lang === 'zh' ? '按' : 'Filter by'} ${tag}`}
              class="py-1 px-2.5 text-sm flex items-center justify-center font-medium shadow-[0_2px_10px_0px_rgba(0,0,0,0.15)] rounded-full whitespace-nowrap text-neutral-700 bg-white"
            >
              {tag}
            </button>
          ))}
        </div>
      </div>
      <div
        class="mt-6 grid gap-y-3 sm:mx-auto sm:w-2/3 md:w-1/2 md:px-4 lg:mx-0 lg:mt-12 lg:w-full lg:grid-cols-2 lg:gap-x-8 lg:gap-y-6 lg:px-8"
      >
        {sortedPosts.map(post => {
          const slug = post.slug.replace(/^(zh|en)\//, '');
          const postUrl = `/zh/blog/${slug}`;

          return (
            <article
              class="grid gap-x-6 gap-y-2 lg:gap-y-0 xl:grid-cols-[15.625rem_auto]"
            >
              <figure
                class="relative w-full self-start rounded-2xl shadow-[0_2px_10px_0px_rgba(0,0,0,0.05)]"
              >
                <img
                  class="h-40 w-full rounded-2xl object-cover object-left-top lg:h-48"
                  src={post.data.image || 'https://images.unsplash.com/photo-1499750310107-5fef28a66643?w=1200&h=600&fit=crop'}
                  alt={post.data.title}
                />
                {post.data.featured && (
                  <div
                    class="items-center justify-center rounded-full text-sm font-medium whitespace-nowrap shadow-[0_2px_10px_0px_rgba(0,0,0,0.15)] bg-white text-neutral-700 px-2.5 py-1 absolute right-3 top-3 z-10 xl:hidden"
                  >
                    {lang === 'zh' ? '精选' : 'Featured'}
                  </div>
                )}
              </figure>
              <div class="flex flex-col items-start p-4 xl:p-0">
                {post.data.featured && (
                  <div
                    class="items-center justify-center rounded-full text-sm font-medium whitespace-nowrap shadow-[0_2px_10px_0px_rgba(0,0,0,0.15)] bg-white text-neutral-700 px-2.5 py-1 hidden xl:block"
                  >
                    {lang === 'zh' ? '精选' : 'Featured'}
                  </div>
                )}
                <div class="xl:mt-2.5">
                  <a
                    class="font-bold text-neutral-700 hover:text-neutral-900 transition-colors"
                    href={postUrl}
                    title={post.data.title}
                  >
                    {post.data.title}
                  </a>
                  <p class="mt-2 text-sm font-medium text-neutral-500">
                    {post.data.description}
                  </p>
                </div>
                <div class="mt-2.5 flex grow items-end">
                  <div class="flex flex-wrap items-center gap-1">
                    <div class="text-sm font-medium text-slate-600">
                      {post.data.author}
                    </div>
                    <div class="flex items-center gap-x-1">
                      <span class="h-1 w-1 rounded-full bg-neutral-200"></span>
                      <time class="text-sm font-medium text-neutral-500">
                        {new Date(post.data.pubDate).toLocaleDateString('zh-CN', {
                          year: 'numeric',
                          month: 'long',
                          day: 'numeric'
                        })}
                      </time>
                    </div>
                  </div>
                </div>
              </div>
            </article>
          );
        })}
      </div>
    </div>
  </section>
</BaseLayout>
